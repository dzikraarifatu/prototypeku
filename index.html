<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADAPTA-NATION AI Powered</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <style>
        :root { --primary: #10b981; --primary-dark: #047857; --accent: #f59e0b; --bg-light: #f3f4f6; --white: #ffffff; --text-dark: #1f2937; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; user-select: none; }
        body { background: #e5e7eb; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .app-container { width: 390px; height: 844px; background: var(--bg-light); border-radius: 40px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; overflow: hidden; border: 8px solid #333; }
        
        /* LOGIN & REGISTER STYLES */
        .login-bg { 
            background: linear-gradient(135deg, #064e3b 0%, #059669 100%) !important;
            color: white !important; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px; 
            z-index: 3000;
        }
        .login-logo { font-size: 80px; margin-bottom: 10px; animation: float 3s infinite ease-in-out; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
        .login-input { 
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 15px; border: none; 
            background: rgba(255,255,255,0.15); color: white; backdrop-filter: blur(5px); outline: none; 
            border: 1px solid rgba(255,255,255,0.5); font-weight: 500;
        }
        .login-input::placeholder { color: rgba(255,255,255,0.8); }
        .login-btn { 
            background: var(--accent); color: white; width: 100%; padding: 15px; border-radius: 15px; 
            border: none; font-weight: bold; font-size: 16px; margin-top: 20px; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.6); transition: 0.3s; 
        }
        .login-btn:active { transform: scale(0.98); }
        .btn-outline-white { background: transparent; border: 2px solid rgba(255,255,255,0.9); color: white; width: 100%; padding: 15px; border-radius: 15px; font-weight: bold; margin-top: 10px; cursor: pointer; transition: 0.3s;}
        .btn-outline-white:hover { background: rgba(255,255,255,0.2); }

        @keyframes float { 0% { transform: translateY(0px) scale(1); } 50% { transform: translateY(-15px) scale(1.05); } 100% { transform: translateY(0px) scale(1); } }

        /* HEADER */
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 40px 20px 25px; color: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); position: relative; z-index: 10; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .coin-badge { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; gap: 5px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); cursor: pointer; }
        
        /* SCREENS & SCROLLING */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-light); display: none; flex-direction: column; overflow-y: auto; padding-bottom: 120px; }
        .screen.active { display: flex; animation: slideUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* COMPONENTS */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 20px; }
        .action-btn { background: var(--white); padding: 20px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 2px solid transparent; }
        .action-btn:active { transform: scale(0.95); }
        .action-btn i { font-size: 28px; color: var(--primary); margin-bottom: 10px; }
        
        /* STATS CHART */
        .chart-container { background: white; border-radius: 20px; padding: 20px; margin: 0 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: flex-end; height: 180px; position: relative; }
        .chart-bar-group { display: flex; flex-direction: column; align-items: center; gap: 8px; width: 30%; height: 100%; justify-content: flex-end; }
        .chart-bar { width: 100%; border-radius: 8px 8px 0 0; position: relative; animation: growBar 1s ease-out forwards; transform-origin: bottom; scale: 1 0; transition: height 1s ease; }
        @keyframes growBar { to { scale: 1 1; } }
        .bar-label { font-size: 10px; color: #666; font-weight: 600; }
        .bar-val { font-size: 12px; font-weight: bold; position: absolute; top: -20px; width: 100%; text-align: center; }
        
        /* LISTS & MAP */
        .list-item { background: white; padding: 15px 20px; margin: 0 20px 10px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .list-item:hover { background: #ecfdf5; color: var(--primary); }
        #map-container-real { height: 100%; width: 100%; z-index: 1; }
        
        /* MARKET (FIXED SCROLL) */
        .category-scroll { 
            display:flex; gap:10px; overflow-x:auto; padding: 10px 20px; 
            scrollbar-width: none;
        }
        .category-scroll::-webkit-scrollbar { display: none; }
        
        .cat-pill { 
            background:white; color:#666; padding:8px 16px; border-radius:20px; font-size:12px; 
            white-space: nowrap; cursor: pointer; border: 1px solid #ddd; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0; 
        }
        .cat-pill.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .market-item { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .market-item:active { transform: scale(0.98); }
        .market-img { height: 100px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 30px; position: relative;}
        .market-info { padding: 10px; }
        .market-price { color: var(--accent); font-weight: bold; font-size: 12px; display: flex; align-items: center; gap: 5px; margin-top: 5px; }
        
        /* RANK & PROFILE */
        .rank-list { padding: 0 20px; margin-top: 10px; }
        .rank-item { display: flex; align-items: center; background: var(--white); padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; transition: all 0.3s ease; }
        .rank-item.top-1 { border: 2px solid #FFD700; background: #fffbeb; }
        .avatar-img { width: 45px; height: 45px; border-radius: 50%; margin: 0 10px; border: 2px solid #eee; background: #f3f4f6; }
        .profile-header { text-align: center; padding: 20px; background: white; margin-bottom: 10px; }
        .profile-pic { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--primary); margin-bottom: 10px; background: #f3f4f6; }
        
        /* PERBAIKAN BADGE SCROLL */
        .badges-scroll { 
            display: flex; gap: 15px; overflow-x: auto; padding: 15px 20px; 
            scrollbar-width: none; scroll-snap-type: x mandatory; 
            padding-right: 20px; 
        }
        .badge-item { 
            min-width: 80px; text-align: center; font-size: 10px; 
            scroll-snap-align: start; 
            flex-shrink: 0;
        }
        .badge-icon { width: 60px; height: 60px; background: #e0f2fe; border-radius: 50%; margin: 0 auto 5px; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #0284c7; }
        
        /* MODALS */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3500; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .modal-box { background: white; width: 85%; padding: 25px; border-radius: 25px; text-align: center; animation: popUp 0.3s ease; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .btn-confirm { background: var(--primary); color: white; padding: 12px; border-radius: 12px; width: 100%; border: none; font-weight: bold; margin-top: 10px; cursor: pointer;}
        .btn-cancel { background: #f3f4f6; color: #666; padding: 12px; border-radius: 12px; width: 100%; border: none; font-weight: bold; margin-top: 10px; cursor: pointer;}
        .btn-error { background: var(--danger); color: white; padding: 12px; border-radius: 12px; width: 100%; border: none; font-weight: bold; margin-top: 10px; cursor: pointer;}
        
        /* NAV */
        .bottom-nav { position: absolute; bottom: 0; width: 100%; height: 75px; background: var(--white); display: flex; justify-content: space-around; align-items: center; border-top-left-radius: 25px; border-top-right-radius: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 10px; gap: 4px; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .nav-fab { background: var(--primary); width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4); transform: translateY(-25px); border: 5px solid var(--bg-light); cursor: pointer; }
        .back-btn { cursor: pointer; margin-right: 15px; font-size: 18px; }
        
        /* CAMERA STYLE UPDATES */
        #camera-feed-container {
            position: absolute; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: #000;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        #camera-canvas { display: none; }
        #captured-image { position: absolute; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 10; }

        @keyframes scanLine { 0% {top:0;} 100% {top:100%;} }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="login" class="screen active login-bg" style="z-index: 3000;">
        <div class="login-logo">üåè</div>
        <h1 style="font-weight: 700; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">ADAPTA-NATION</h1>
        <p style="opacity: 0.9; margin-bottom: 40px; font-size: 20px; font-weight: 500;"> From Apathy To Action</p>
        
        <input type="text" placeholder="Email" class="login-input" value="rian@adapta.id">
        <input type="password" placeholder="Password" class="login-input" value="123456">
        
        <button class="login-btn" onclick="doLogin()">Masuk Sekarang</button>
        <button class="btn-outline-white" onclick="navTo('register')">Daftar Akun Baru</button>
        
        <p style="font-size: 16px; margin-top: 30px; opacity: 0.8;">Save Our Home</p>
    </div>

    <div id="register" class="screen login-bg" style="z-index: 3000;">
        <div style="width:100%; text-align:left; margin-bottom:20px;">
            <i class="fas fa-arrow-left" style="font-size:24px; cursor:pointer;" onclick="navTo('login')"></i>
        </div>
        <h2 style="margin-bottom: 20px;">Buat Akun</h2>
        <input type="text" id="reg-name" placeholder="Nama Lengkap" class="login-input">
        <input type="email" placeholder="Email" class="login-input">
        <input type="password" placeholder="Password" class="login-input">
        <input type="password" placeholder="Konfirmasi Password" class="login-input">
        <button class="login-btn" onclick="doRegisterSubmit()">Daftar Sekarang</button>
    </div>

    <div id="home" class="screen">
        <div class="header">
            <div class="header-top">
                <div class="user-info"><p>Halo Adaptans,</p><h2 id="home-username">Arifatu Dzikra</h2></div>
                <div class="coin-badge" onclick="navTo('market')"><i class="fas fa-coins" style="color: #fbbf24;"></i><span id="coin-display">1.250</span></div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 15px; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
                    <span id="user-level-display">Level 5: Penjaga Sungai</span><span id="xp-text-home">75%</span>
                </div>
                <div style="width: 100%; height: 6px; background: rgba(0,0,0,0.2); border-radius: 10px; overflow:hidden;">
                    <div id="xp-bar-home" style="width: 75%; height: 100%; background: #fbbf24; border-radius: 10px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);"></div>
                </div>
            </div>
        </div>
        <div style="padding-top: 20px;">
            <h3 style="margin: 0 20px 15px; font-size: 18px;">Menu Utama</h3>
            <div class="action-grid">
                <div class="action-btn" onclick="openMapSelection()"><i class="fas fa-map-location-dot"></i><h4>Peta Misi</h4><p style="font-size: 10px; color: #888;">Cari Area Rawan</p></div>
                <div class="action-btn" onclick="navTo('market')"><i class="fas fa-store"></i><h4>Tukar Poin</h4><p style="font-size: 10px; color: #888;">Market & Donasi</p></div>
            </div>
            <h3 style="margin: 25px 20px 30px; font-size: 18px;">Statistik Dampak</h3>
            <div class="chart-container">
                <div class="chart-bar-group"><span class="bar-val" style="color:var(--primary)" id="stat-waste-val">12kg</span><div class="chart-bar" style="height: 60%; background: var(--primary);"></div><span class="bar-label">Sampah</span></div>
                <div class="chart-bar-group"><span class="bar-val" style="color:var(--text-dark)" id="stat-co2-val">4kg</span><div class="chart-bar" style="height: 30%; background: #374151;"></div><span class="bar-label">CO2 Cut</span></div>
                <div class="chart-bar-group"><span class="bar-val" style="color:var(--accent)" id="stat-mission-val">8</span><div class="chart-bar" style="height: 80%; background: var(--accent);"></div><span class="bar-label">Misi</span></div>
            </div>
        </div>
    </div>

    <div id="map-select" class="screen">
        <div class="header" style="padding-bottom: 20px;"><div style="display:flex; align-items:center;"><i class="fas fa-arrow-left back-btn" onclick="navTo('home')"></i><h2>Pilih Provinsi</h2></div></div>
        <div style="padding: 10px 0; height: 100%; overflow-y: scroll;" id="province-list-container"></div>
    </div>
    <div id="city-select" class="screen">
        <div class="header" style="padding-bottom: 20px; background: linear-gradient(135deg, #059669, #047857);"><div style="display:flex; align-items:center;"><i class="fas fa-arrow-left back-btn" onclick="navTo('map-select')"></i><h2 id="province-title">Provinsi</h2></div></div>
        <div id="city-list" style="padding: 10px 0; overflow-y: scroll;"></div>
    </div>
    <div id="map-view" class="screen" style="padding-bottom: 0;">
        <div class="header" style="padding: 15px 20px; position:absolute; top:0; left:0; width:100%; z-index:1000; height: 80px;"><div style="display:flex; align-items:center; justify-content:space-between;"><i class="fas fa-arrow-left back-btn" onclick="navTo('city-select')"></i><h3 id="map-city-name" style="font-size:14px; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Peta</h3></div></div>
        <div id="map-container-real"></div>
        <button class="action-btn" style="position:absolute; bottom:90px; left:50%; transform:translateX(-50%); width:80%; background:var(--primary); color:white; border:none; z-index:1000; box-shadow: 0 5px 15px rgba(0,0,0,0.3);" onclick="navTo('scan')"><i class="fas fa-camera" style="font-size:18px; margin:0 5px 0 0; color:white;"></i> Lapor di Lokasi Ini</button>
    </div>

    <div id="rank" class="screen">
        <div class="header" style="border-radius: 0 0 25px 25px;"><h2 style="text-align: center;">Leaderboard</h2><p style="text-align: center; font-size: 12px; opacity: 0.8;">Kota Padang - Minggu Ini</p></div>
        <div class="rank-list" id="rank-list-container" style="padding-top: 20px;"></div>
    </div>

    <div id="market" class="screen">
        <div class="header"><h2>Marketplace</h2><div style="display:flex; justify-content:space-between; margin-top:10px;"><span style="font-size:12px; opacity:0.9;">Saldo: <b id="market-balance-display">1.250 GC</b></span><span style="font-size:12px; text-decoration: underline; cursor: pointer;" onclick="openHistory()">Riwayat</span></div></div>
        <div class="category-scroll">
            <span class="cat-pill active" onclick="filterMarket('all', this)">Semua</span><span class="cat-pill" onclick="filterMarket('pulsa', this)">Pulsa & Data</span><span class="cat-pill" onclick="filterMarket('wallet', this)">E-Wallet</span><span class="cat-pill" onclick="filterMarket('umkm', this)">Produk Eco</span><span class="cat-pill" onclick="filterMarket('donasi', this)">Donasi</span><span class="cat-pill" onclick="filterMarket('promo', this)">Promo Spesial</span><span class="cat-pill" onclick="filterMarket('voucher', this)">Voucher Game</span>
        </div>
        <div class="market-grid" id="market-items"></div>
    </div>

    <div id="profile" class="screen">
        <div class="profile-header">
            <img src="https://api.dicebear.com/7.x/notionists/svg?seed=Rian&gender=male" class="profile-pic"><h2 id="profile-username">Arifatu Dzikra</h2><p style="color:#666; font-size:12px;">Bergabung sejak 2025</p>
            <div style="display:flex; justify-content:center; gap:20px; margin-top:15px;"><div style="text-align:center;"><b style="font-size:18px; color:var(--primary);" id="stat-mission-profile">12</b><div style="font-size:10px; color:#888;">Misi</div></div><div style="text-align:center;"><b style="font-size:18px; color:var(--accent);" id="profile-coin-display">1.2k</b><div style="font-size:10px; color:#888;">Koin</div></div><div style="text-align:center;"><b style="font-size:18px; color:#333;" id="profile-rank-display">#4</b><div style="font-size:10px; color:#888;">Rank</div></div></div>
        </div>
        <h3 style="margin:0 20px 10px; font-size:14px;">Koleksi Badge</h3>
        <div class="badges-scroll">
            <div class="badge-item"><div class="badge-icon"><i class="fas fa-water"></i></div><span>Penjaga Sungai</span></div><div class="badge-item"><div class="badge-icon" style="background:#fef3c7; color:#d97706;"><i class="fas fa-recycle"></i></div><span>Adaptans Pilah</span></div><div class="badge-item"><div class="badge-icon" style="background:#fce7f3; color:#db2777;"><i class="fas fa-heart"></i></div><span>Peduli Sesama</span></div><div class="badge-item"><div class="badge-icon" style="background:#e5e7eb; color:#666;"><i class="fas fa-lock"></i></div><span>Terkunci</span></div><div class="badge-item"><div class="badge-icon" style="background:#e5e7eb; color:#666;"><i class="fas fa-lock"></i></div><span>Terkunci</span></div><div class="badge-item"><div class="badge-icon" style="background:#e5e7eb; color:#666;"><i class="fas fa-lock"></i></div><span>Terkunci</span></div>
        </div>
        <h3 style="margin:20px 20px 10px; font-size:14px;">Riwayat Aksi</h3>
        <div style="padding:0 20px;" id="profile-action-history"></div>
        <button class="action-btn" style="margin: 20px; width:calc(100% - 40px); background:#fee2e2; border:none; color:#ef4444;" onclick="doLogout()"><i class="fas fa-sign-out-alt" style="font-size:16px; margin:0;"></i> Logout</button>
    </div>

    <div id="scan" class="screen" style="background: black;">
        <div id="camera-feed-container">
            <video id="video-feed" autoplay playsinline></video>
            <canvas id="camera-canvas"></canvas>
            <img id="captured-image" src="" alt="Captured">
            <div style="position:absolute; width:100%; height:100%; display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr; z-index:5;"><div style="border:1px solid rgba(255,255,255,0.1);"></div><div style="border:1px solid rgba(255,255,255,0.1);"></div><div style="border:1px solid rgba(255,255,255,0.1);"></div><div style="border:1px solid rgba(255,255,255,0.1);"></div><div style="border:1px solid rgba(255,255,255,0.1);"></div><div style="border:1px solid rgba(255,255,255,0.1);"></div><div style="border:1px solid rgba(255,255,255,0.1);"></div><div style="border:1px solid rgba(255,255,255,0.1);"></div><div style="border:1px solid rgba(255,255,255,0.1);"></div></div>
            <div id="scanning-anim" style="display:none; position:absolute; top:20%; left:10%; width:80%; height:60%; border:3px solid var(--primary); box-shadow:0 0 15px var(--primary); border-radius:10px; overflow:hidden; z-index:20;"><div style="width:100%; height:5px; background:var(--primary); box-shadow:0 0 10px white; position:absolute; animation:scanLine 1.5s infinite;"></div><div style="position:absolute; bottom:10px; left:0; width:100%; text-align:center; color:white; font-weight:bold; text-shadow:0 1px 2px black;">Menganalisis AI...</div></div>
        </div>
        <div style="position:absolute; bottom:0; width:100%; height:150px; background:linear-gradient(to top, black, transparent); display:flex; justify-content:space-around; align-items:center; padding:0 20px; z-index:30;">
            <div onclick="navTo('home')" style="color:white; font-size:12px; cursor:pointer;">Batal</div>
            <div onclick="takePhoto()" style="width:70px; height:70px; border-radius:50%; border:4px solid white; display:flex; justify-content:center; align-items:center; cursor:pointer; background:rgba(255,255,255,0.2);">
                <div style="width:60px; height:60px; background:white; border-radius:50%;"></div>
            </div>
            <div style="color:white; font-size:24px;"><i class="fas fa-bolt"></i></div>
        </div>
    </div>

    <div id="register-success-modal" class="modal" style="z-index: 3500;">
        <div class="modal-box">
            <div style="font-size:60px; margin-bottom:10px;">‚úÖ</div>
            <h2 style="color:var(--primary);">Akun Berhasil Dibuat!</h2>
            <p style="font-size:14px; color:#666; margin:10px 0;">Selamat datang di ADAPTA-NATION. Mari mulai aksi nyata!</p>
            <button class="btn-confirm" onclick="finishRegister()">Mulai Aksi</button>
        </div>
    </div>

    <div id="reward-modal" class="modal">
        <div class="modal-box">
            <div style="font-size:60px; margin-bottom:10px;">üéâ</div>
            <h2 style="color:var(--primary);">Sampah Terdeteksi!</h2>
            <p style="font-size:14px; color:#666; margin:10px 0;" id="ai-result-text">Jenis: <b>Menganalisis...</b></p>
            <div style="background:#fffbeb; padding:15px; border-radius:15px; border:1px solid #fcd34d; margin:15px 0; display:flex; justify-content:space-around;">
                <div style="font-size:18px; font-weight:bold; color:var(--accent);" id="ai-reward-coin">+ 0 Poin</div>
                <div style="font-size:18px; font-weight:bold; color:var(--primary);" id="ai-reward-xp">+ 0 XP</div>
            </div>
            <button class="btn-confirm" onclick="claimReward()">Klaim Poin & XP</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal"><div class="modal-box"><div style="font-size:40px; margin-bottom:10px;" id="modal-icon">üõí</div><h3 id="modal-title">Konfirmasi</h3><p style="font-size:12px; color:#666; margin:10px 0;" id="modal-desc">...</p><div style="background:#f3f4f6; padding:10px; border-radius:10px; font-size:12px; margin-bottom:10px;">Saldo Sisa: <b style="color:var(--primary);" id="modal-balance">...</b></div><button class="btn-confirm" onclick="processTransaction()">Ya, Tukar Sekarang</button><button class="btn-cancel" onclick="closeModal()">Batal</button></div></div>
    <div id="transaction-success-modal" class="modal"><div class="modal-box"><div style="font-size:60px; margin-bottom:10px;">üéâ</div><h2 style="color:var(--primary);">Penukaran Berhasil!</h2><p style="font-size:14px; color:#666; margin:10px 0;">Item telah ditambahkan ke inventaris.</p><div style="background:#ecfdf5; padding:15px; border-radius:15px; border:1px solid #10b981; margin:15px 0;"><div style="font-size:18px; font-weight:bold; color:var(--primary);" id="success-item-name">Pulsa 10k</div></div><button class="btn-confirm" onclick="closeSuccessModal()">OK</button></div></div>
    <div id="insufficient-modal" class="modal"><div class="modal-box"><div style="font-size:60px; margin-bottom:10px; color:var(--danger);">‚ùå</div><h2 style="color:var(--danger);">Saldo Tidak Cukup</h2><p style="font-size:14px; color:#666; margin:10px 0;">Kumpulkan lebih banyak Green Coin dengan melakukan aksi lingkungan!</p><button class="btn-error" onclick="document.getElementById('insufficient-modal').style.display='none'">Tutup</button></div></div>
    <div id="levelup-modal" class="modal" style="z-index: 2500;"><div class="modal-box" style="background: linear-gradient(135deg, #fffbeb, #fff);"><div style="font-size:70px; margin-bottom:10px;">üöÄ</div><h2 style="color:var(--accent); font-size: 24px;">LEVEL UP!</h2><p style="font-size:16px; color:#333; margin:10px 0;">Selamat! Anda naik ke level baru.</p><div style="background:var(--accent); color:white; padding:15px; border-radius:15px; margin:20px 0; font-weight:bold; font-size: 18px;" id="new-level-name">Level 6</div><button class="btn-confirm" style="background: var(--accent);" onclick="document.getElementById('levelup-modal').style.display='none'">Lanjutkan Aksi!</button></div></div>
    <div id="history-modal" class="modal"><div class="modal-box" style="text-align:left; max-height:60%; overflow-y:auto;"><h3 style="text-align:center; margin-bottom:15px;">Riwayat Transaksi</h3><div id="history-list"><p style="font-size:12px; color:#999; text-align:center;">Belum ada penukaran baru.</p></div><button class="btn-cancel" onclick="document.getElementById('history-modal').style.display='none'">Tutup</button></div></div>

    <div id="bottom-nav" class="bottom-nav" style="display:none;">
        <div class="nav-item active" onclick="navTo('home')"><i class="fas fa-home"></i> <span>Home</span></div>
        <div class="nav-item" onclick="navTo('rank')"><i class="fas fa-trophy"></i> <span>Rank</span></div>
        <div class="nav-fab" onclick="navTo('scan')"><i class="fas fa-camera"></i></div>
        <div class="nav-item" onclick="navTo('market')"><i class="fas fa-store"></i> <span>Market</span></div>
        <div class="nav-item" onclick="navTo('profile')"><i class="fas fa-user"></i> <span>Profil</span></div>
    </div>
</div>

<script>
// --- GLOBAL VARS ---
let userBalance = 1250; 
let userTotalXP = 750; 
const xpPerLevel = 1000;
let transactionHistory = [];
let actionHistoryLog = [ { title: "Pilah Sampah Organik", date: "Hari ini, 10:00", coin: "+500" }, { title: "Lapor Selokan Mampet", date: "Kemarin", coin: "+300" } ];
let statWaste = 12; let statCO2 = 4; let statMissions = 8;
let leaderboardData = [
    { id: 'siti', name: 'Siti Aminah', role: 'Duta Lingkungan', xp: 5200, avatar: 'https://api.dicebear.com/7.x/notionists/svg?seed=Siti&gender=female', isUser: false },
    { id: 'budi', name: 'Budi Santoso', role: 'Mahasiswa', xp: 4800, avatar: 'https://api.dicebear.com/7.x/notionists/svg?seed=Budi&gender=male', isUser: false },
    { id: 'burt', name: 'Bu RT 05', role: 'Tokoh Warga', xp: 4100, avatar: 'https://api.dicebear.com/7.x/notionists/svg?seed=BuRT&gender=female', isUser: false },
    { id: 'user', name: 'Arifatu Dzikra (Anda)', role: 'Penjaga Sungai', xp: 750, avatar: 'https://api.dicebear.com/7.x/notionists/svg?seed=Rian&gender=male', isUser: true }
];

// --- AI VARIABLES ---
let aiModel = null;
let currentDetectedTrash = "Sampah Residu";
let currentRewardCoin = 100;
let currentRewardXP = 50;

// --- LOAD AI MODEL ---
async function loadAI() {
    console.log("Memuat Model AI...");
    try {
        aiModel = await cocoSsd.load();
        console.log("Model AI Siap!");
    } catch (e) {
        console.log("Gagal memuat AI, menggunakan mode simulasi.");
    }
}

window.onload = function() { 
    renderProvinceList(); renderMarket('all'); updateBalanceUI(); renderActionHistory(); renderLeaderboard(); 
    document.querySelectorAll('.category-scroll, .badges-scroll').forEach(enableDragScroll);
    loadAI(); // Start loading AI immediately
};

// --- DRAG SCROLL ---
function enableDragScroll(elm) {
    let isDown = false; let startX; let scrollLeft;
    elm.addEventListener('mousedown', (e) => { isDown = true; elm.style.cursor = 'grabbing'; startX = e.pageX - elm.offsetLeft; scrollLeft = elm.scrollLeft; });
    elm.addEventListener('mouseleave', () => { isDown = false; elm.style.cursor = 'grab'; });
    elm.addEventListener('mouseup', () => { isDown = false; elm.style.cursor = 'grab'; });
    elm.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - elm.offsetLeft; const walk = (x - startX) * 2; elm.scrollLeft = scrollLeft - walk; });
}

// --- LOGIC UTAMA ---
function doLogin() { document.getElementById('login').classList.remove('active'); document.getElementById('home').classList.add('active'); document.getElementById('bottom-nav').style.display='flex'; }
function doLogout() { document.getElementById('home').classList.remove('active'); document.getElementById('profile').classList.remove('active'); document.getElementById('login').classList.add('active'); document.getElementById('bottom-nav').style.display='none'; }
function doRegister() { navTo('register'); }
function doRegisterSubmit() { 
    const newName = document.getElementById('reg-name').value;
    if(newName.trim() !== "") {
        document.getElementById('home-username').innerText = newName;
        document.getElementById('profile-username').innerText = newName;
        let userIndex = leaderboardData.findIndex(u => u.isUser === true);
        if(userIndex !== -1) { leaderboardData[userIndex].name = newName + " (Anda)"; }
        renderLeaderboard();
    }
    document.getElementById('register-success-modal').style.display = 'flex';
}
function finishRegister() {
    document.getElementById('register-success-modal').style.display = 'none';
    document.getElementById('register').classList.remove('active');
    document.getElementById('login').classList.remove('active');
    document.getElementById('home').classList.add('active');
    document.getElementById('bottom-nav').style.display='flex';
}

function navTo(screenId) { 
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); 
    if(screenId !== 'login' && screenId !== 'register') document.getElementById('bottom-nav').style.display='flex';
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); 
    if(screenId !== 'login') document.getElementById(screenId).classList.add('active');
    if(screenId === 'home') document.querySelectorAll('.nav-item')[0].classList.add('active'); 
    if(screenId === 'rank') document.querySelectorAll('.nav-item')[1].classList.add('active'); 
    if(screenId === 'market') document.querySelectorAll('.nav-item')[2].classList.add('active'); 
    if(screenId === 'profile') document.querySelectorAll('.nav-item')[3].classList.add('active'); 
    
    if(screenId === 'scan') { 
        startCamera(); 
    } else {
        stopCamera();
    }
    
    if(screenId === 'map-view' && map) setTimeout(() => map.invalidateSize(), 300); 
}

// --- CAMERA & AI LOGIC ---
let videoStream = null;

function startCamera() {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function (stream) {
            videoStream = stream;
            const video = document.getElementById('video-feed');
            video.srcObject = stream;
            video.play();
            document.getElementById('captured-image').style.display = 'none';
            video.style.display = 'block';
        })
        .catch(function (err) {
            console.log("Error Camera", err);
            alert("Kamera tidak dapat diakses. Pastikan izin diberikan atau gunakan HTTPS/Localhost.");
        });
    }
}

function stopCamera() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
}

async function takePhoto() {
    const video = document.getElementById('video-feed');
    const canvas = document.getElementById('camera-canvas');
    const photo = document.getElementById('captured-image');
    
    // Capture Frame
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Show Photo
    photo.src = canvas.toDataURL('image/png');
    photo.style.display = 'block';
    video.style.display = 'none';
    
    // UI Analysis
    document.getElementById('scanning-anim').style.display = 'block';
    
    // RUN AI DETECTION
    if(aiModel) {
        try {
            const predictions = await aiModel.detect(photo);
            processAIDetection(predictions);
        } catch (e) {
            console.log("AI Error", e);
            fallbackDetection();
        }
    } else {
        fallbackDetection();
    }
}

function processAIDetection(predictions) {
    // Default Result
    currentDetectedTrash = "Sampah Residu (Lainnya)";
    currentRewardCoin = 100;
    currentRewardXP = 50;

    if (predictions.length > 0) {
        // Ambil prediksi dengan skor tertinggi
        const topPred = predictions[0].class.toLowerCase();
        console.log("AI Detected:", topPred);

        // Logic Klasifikasi Sampah
        if (['bottle', 'cup', 'wine glass', 'vase'].includes(topPred)) {
            currentDetectedTrash = "Sampah Plastik/Kaca (Anorganik)";
            currentRewardCoin = 500; currentRewardXP = 200;
        } else if (['apple', 'banana', 'orange', 'broccoli', 'carrot', 'sandwich', 'pizza', 'donut', 'cake'].includes(topPred)) {
            currentDetectedTrash = "Sampah Organik (Kompos)";
            currentRewardCoin = 300; currentRewardXP = 150;
        } else if (['book', 'paper', 'cardboard'].includes(topPred)) {
            currentDetectedTrash = "Kertas/Kardus (Daur Ulang)";
            currentRewardCoin = 200; currentRewardXP = 100;
        } else if (['cell phone', 'laptop', 'mouse', 'keyboard', 'remote', 'tv'].includes(topPred)) {
            currentDetectedTrash = "E-Waste (Elektronik)";
            currentRewardCoin = 1000; currentRewardXP = 500;
        } else if (['can', 'fork', 'knife', 'spoon'].includes(topPred)) {
            currentDetectedTrash = "Logam/Kaleng";
            currentRewardCoin = 700; currentRewardXP = 300;
        } else {
            currentDetectedTrash = `Objek Terdeteksi: ${topPred}`;
        }
    } else {
        currentDetectedTrash = "Objek Tidak Dikenal";
    }
    
    showResultModal();
}

function fallbackDetection() {
    // Simulasi jika AI gagal/belum load
    setTimeout(() => {
        const types = [
            {t: "Botol Plastik", c: 500, x: 200},
            {t: "Sampah Organik", c: 300, x: 150},
            {t: "Kertas Bekas", c: 200, x: 100}
        ];
        const rand = types[Math.floor(Math.random() * types.length)];
        currentDetectedTrash = rand.t + " (Simulasi)";
        currentRewardCoin = rand.c;
        currentRewardXP = rand.x;
        showResultModal();
    }, 2000);
}

function showResultModal() {
    setTimeout(() => {
        document.getElementById('scanning-anim').style.display = 'none';
        
        // Update Modal Content
        document.getElementById('ai-result-text').innerHTML = `Jenis: <b>${currentDetectedTrash}</b>`;
        document.getElementById('ai-reward-coin').innerText = `+ ${currentRewardCoin} Poin`;
        document.getElementById('ai-reward-xp').innerText = `+ ${currentRewardXP} XP`;
        
        document.getElementById('reward-modal').style.display = 'flex';
        stopCamera();
    }, 1500); // Sedikit delay biar animasi terlihat
}

function claimReward() { 
    userBalance += currentRewardCoin; 
    
    statWaste += 1.5; statCO2 += 0.5; statMissions += 1;

    let levelBefore = Math.floor(userTotalXP / xpPerLevel) + 1;
    userTotalXP += currentRewardXP; 
    let levelAfter = Math.floor(userTotalXP / xpPerLevel) + 1;

    actionHistoryLog.unshift({ title: `Deteksi AI: ${currentDetectedTrash.split('(')[0]}`, date: "Baru saja", coin: `+${currentRewardCoin}` }); 
    renderActionHistory();
    updateBalanceUI(); 
    document.getElementById('reward-modal').style.display = 'none'; 
    
    if (levelAfter > levelBefore) {
        document.getElementById('new-level-name').innerText = "Level " + levelAfter;
        document.getElementById('levelup-modal').style.display = 'flex';
    }
    navTo('home'); 
}

// --- HELPER FUNCTIONS ---
function openMapSelection() { navTo('map-select'); }
function renderProvinceList() { const list = document.getElementById('province-list-container'); list.innerHTML = ''; Object.keys(indonesiaMapData).sort().forEach(prov => { list.innerHTML += `<div class="list-item" onclick="openCitySelect('${prov}')"><b>${prov}</b><i class="fas fa-chevron-right"></i></div>`; }); }
function openCitySelect(province) { navTo('city-select'); document.getElementById('province-title').innerText = province; const list = document.getElementById('city-list'); list.innerHTML = ''; indonesiaMapData[province].forEach(city => { list.innerHTML += `<div class="list-item" onclick="loadRealMap('${city}')"><div style="display:flex; gap:10px;"><i class="fas fa-city" style="color:var(--primary)"></i><b>${city}</b></div></div>`; }); }
function loadRealMap(cityName) { navTo('map-view'); document.getElementById('map-city-name').innerText = cityName; let coords = cityCoordinates[cityName] || [-6.1751, 106.8650]; if (map !== null) map.remove(); setTimeout(() => { map = L.map('map-container-real').setView(coords, 14); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); L.circle(coords, {color: 'red', radius: 300}).addTo(map); }, 500); }
function renderMarket(filter) { const grid = document.getElementById('market-items'); grid.innerHTML = ''; marketItems.forEach(item => { if(filter === 'all' || item.cat === filter) { grid.innerHTML += `<div class="market-item" onclick="openConfirm(${item.id})"><div class="market-img" style="color:${item.color}"><i class="fas ${item.icon}"></i></div><div class="market-info"><div style="font-weight:bold; font-size:13px;">${item.name}</div><div class="market-price"><i class="fas fa-coins"></i> ${item.price}</div></div></div>`; } }); }
function filterMarket(cat, el) { document.querySelectorAll('.cat-pill').forEach(c => c.classList.remove('active')); el.classList.add('active'); renderMarket(cat); }
function openConfirm(id) { currentItem = marketItems.find(i => i.id === id); document.getElementById('modal-title').innerText = currentItem.name; document.getElementById('modal-desc').innerText = `Harga: ${currentItem.price} GC`; document.getElementById('modal-icon').innerHTML = `<i class="fas ${currentItem.icon}" style="color:${currentItem.color}"></i>`; document.getElementById('modal-balance').innerText = `${userBalance - currentItem.price} GC (Sisa)`; document.getElementById('confirm-modal').style.display = 'flex'; }
function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }
function closeSuccessModal() { document.getElementById('transaction-success-modal').style.display = 'none'; }
function processTransaction() { if(userBalance >= currentItem.price) { userBalance -= currentItem.price; updateBalanceUI(); transactionHistory.unshift({name: currentItem.name, price: currentItem.price, date: new Date().toLocaleTimeString()}); closeModal(); document.getElementById('success-item-name').innerText = currentItem.name; document.getElementById('transaction-success-modal').style.display = 'flex'; } else { closeModal(); document.getElementById('insufficient-modal').style.display = 'flex'; } }
function openHistory() { const list = document.getElementById('history-list'); if(transactionHistory.length === 0) { list.innerHTML = '<p style="font-size:12px; color:#999; text-align:center;">Belum ada penukaran baru.</p>'; } else { list.innerHTML = ''; transactionHistory.forEach(h => { list.innerHTML += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px 0; font-size:12px;"><span>${h.name}</span><b style="color:#ef4444;">-${h.price}</b></div>`; }); } document.getElementById('history-modal').style.display = 'flex'; }
</script>
</body>
</html>
